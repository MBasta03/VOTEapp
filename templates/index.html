<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Test wideo</title>

<style>
body {
    margin: 0;
    background: #363637;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
}

.hidden { display: none; }

#frame, #exampleFrame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #363637;
}

video {
    max-width: 100%;
    max-height: 100%;
}

/* Ukryj natywne kontrolki odtwarzacza w większości przeglądarek */
video::-webkit-media-controls,
video::-webkit-media-controls-panel,
video::-webkit-media-controls-enclosure {
    display: none !important;
    -webkit-appearance: none;
}

button {
    font-size: 26px;
    padding: 20px 40px;
    margin: 10px;
    cursor: pointer;
}

.rating-btn {
    width: 80px;
}

.rating-btn:hover:not(.selected) {
    background: green;
    color: white;
}

.rating-btn.selected {
    background: green;
    color: white;
}

#confirm {
    background: darkgreen;
    color: white;
}
</style>
</head>

<body>

<!-- ================= DANE TESTERA ================= -->
<div id="introScreen">
    <h1>Witaj w teście wideo</h1>
    <p>Podaj kilka informacji o sobie przed rozpoczęciem.</p>
    <div>
        <label>ID testera:
            <input id="testerIdInput" type="text" required>
        </label>
    </div>
    <div>
        <label>Wiek:
            <input id="ageInput" type="number" min="10" max="120" required>
        </label>
    </div>
    <div>
        <label>Płeć:</label>
        <label><input type="radio" name="gender" value="kobieta">Kobieta</label>
        <label><input type="radio" name="gender" value="mężczyzna">Mężczyzna</label>
        <label><input type="radio" name="gender" value="inna">Inna / wolę nie podawać</label>
    </div>
    <div>
        <label>Ulubiony gatunek filmu:
            <select id="genreSelect" required>
                <option value="">-- wybierz --</option>
                <option value="akcja">Akcja</option>
                <option value="komedia">Komedia</option>
                <option value="dramat">Dramat</option>
                <option value="horror">Horror</option>
                <option value="sci-fi">Sci-fi</option>
                <option value="dokument">Dokument</option>
                <option value="inny">Inny</option>
            </select>
        </label>
    </div>
    <button onclick="showInstruction()">Dalej</button>
</div>

<!-- ================= INSTRUKCJA ================= -->
<div id="instructionScreen" class="hidden">
    <h1>ZOSTANIESZ PODDANY TESTOWI POLEGAJĄCEMU NA OCENIE JAKOŚCI FILMÓW NA RÓŻNYCH URZĄDZENIACH</h1>
    <button onclick="startExampleTest()">ROZPOCZNIJ PRZYKŁADOWY TEST</button>
</div>

<!-- ================= PRZYKŁADOWY TEST ================= -->
<div id="exampleTestScreen" class="hidden">
    <!-- ===== FILM ===== -->
    <div id="exampleVideoContainer">
        <div id="exampleFrame">
            <video id="exampleVideo"></video>
        </div>
    </div>

    <!-- ===== OCENA ===== -->
    <div id="exampleRatingContainer" class="hidden">
        <h1>Oceń film</h1>

        <div>
            <button class="rating-btn" onclick="selectExampleRating(1)">1</button>
            <button class="rating-btn" onclick="selectExampleRating(2)">2</button>
            <button class="rating-btn" onclick="selectExampleRating(3)">3</button>
            <button class="rating-btn" onclick="selectExampleRating(4)">4</button>
            <button class="rating-btn" onclick="selectExampleRating(5)">5</button>
        </div>

        <div>
            <button id="exampleConfirm" onclick="confirmExampleRating()">ZATWIERDŹ</button>
        </div>
    </div>
</div>

<!-- ================= PRZYCISK ROZPOCZNIJ TEST ================= -->
<div id="startRealTestScreen" class="hidden">
    <h1>Przykładowy test zakończony</h1>
    <button onclick="startRealTest()">ROZPOCZNIJ TEST</button>
</div>

<!-- ================= WYBÓR URZĄDZENIA ================= -->
<div id="deviceScreen" class="hidden">
    <h1>Wybierz urządzenie</h1>
    <button onclick="selectDevice('monitor')">Monitor</button>
    <button onclick="selectDevice('tablet')">Tablet</button>
    <button onclick="selectDevice('telefon')">Telefon</button>
</div>

<!-- ================= TEST ================= -->
<div id="testScreen" class="hidden">

    <!-- ===== FILM ===== -->
    <div id="videoContainer">
        <div id="frame">
            <video id="video"></video>
        </div>
    </div>

    <!-- ===== OCENA ===== -->
    <div id="ratingContainer" class="hidden">
        <h1>Oceń film</h1>

        <div>
            <button class="rating-btn" onclick="selectRating(1)">1</button>
            <button class="rating-btn" onclick="selectRating(2)">2</button>
            <button class="rating-btn" onclick="selectRating(3)">3</button>
            <button class="rating-btn" onclick="selectRating(4)">4</button>
            <button class="rating-btn" onclick="selectRating(5)">5</button>
        </div>

        <div>
            <button id="confirm" onclick="confirmRating()">ZATWIERDŹ</button>
        </div>
    </div>

</div>


<!-- ================= KONIEC ================= -->
<div id="endScreen" class="hidden">
    <h1>Dziękujemy za udział w teście</h1>
</div>

<script>
    const videoContainer = document.getElementById("videoContainer");
const ratingContainer = document.getElementById("ratingContainer");

const videos = {{ videos|tojson }};

const devices = {
    monitor: [1920,1080],
    tablet: [900,700],
    telefon: [360,640]
};

let device = null;
let videoIndex = 0;
let rating = null;
let testerData = null;
let shuffledVideos = []; // Losowa kolejność filmów dla właściwego testu

const introScreen = document.getElementById("introScreen");
const instructionScreen = document.getElementById("instructionScreen");
const exampleTestScreen = document.getElementById("exampleTestScreen");
const startRealTestScreen = document.getElementById("startRealTestScreen");
const deviceScreen = document.getElementById("deviceScreen");
const testScreen = document.getElementById("testScreen");
const endScreen = document.getElementById("endScreen");

const video = document.getElementById("video");
const exampleVideo = document.getElementById("exampleVideo");
const frame = document.getElementById("frame");
const exampleFrame = document.getElementById("exampleFrame");
const testerIdInput = document.getElementById("testerIdInput");
const ageInput = document.getElementById("ageInput");
const genreSelect = document.getElementById("genreSelect");

let isExampleTest = false;
let exampleRating = null;

// Blokada pauzowania klawiaturą (spacja, strzałki) na czas testu
document.addEventListener("keydown", (e) => {
    const fullscreenElement = document.fullscreenElement;
    if (fullscreenElement === video || fullscreenElement === exampleVideo) {
        if ([" ", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "k", "j", "l"].includes(e.key)) {
            e.preventDefault();
        }
    }
});

/* ================= DANE TESTERA ================= */
function showInstruction() {
    const testerId = testerIdInput.value.trim();
    const age = parseInt(ageInput.value, 10);
    const gender = document.querySelector("input[name='gender']:checked")?.value;
    const genre = genreSelect.value;

    if (!testerId) {
        alert("Podaj ID testera.");
        return;
    }
    if (!age || age < 10 || age > 120) {
        alert("Podaj poprawny wiek (10-120).");
        return;
    }
    if (!gender) {
        alert("Wybierz płeć.");
        return;
    }
    if (!genre) {
        alert("Wybierz ulubiony gatunek filmu.");
        return;
    }

    testerData = { id: testerId, age, gender, genre };
    introScreen.classList.add("hidden");
    instructionScreen.classList.remove("hidden");
}

function startExampleTest() {
    instructionScreen.classList.add("hidden");
    exampleTestScreen.classList.remove("hidden");
    isExampleTest = true;
    
    exampleFrame.style.width = devices.monitor[0] + "px";
    exampleFrame.style.height = devices.monitor[1] + "px";
    
    loadExampleVideo();
}

function startRealTest() {
    startRealTestScreen.classList.add("hidden");
    deviceScreen.classList.remove("hidden");
    isExampleTest = false;
    videoIndex = 0;
    
    // Tworzymy losową kolejność filmów, pomijając pierwszy (użyty w przykładowym teście)
    const videosForTest = videos.slice(1); // Wszystkie filmy oprócz pierwszego
    shuffledVideos = [...videosForTest];
    // Funkcja do mieszania tablicy (Fisher-Yates shuffle)
    for (let i = shuffledVideos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledVideos[i], shuffledVideos[j]] = [shuffledVideos[j], shuffledVideos[i]];
    }
}

/* ================= FULLSCREEN ================= */
function enterFullscreen(elem) {
    if (elem.requestFullscreen) elem.requestFullscreen();
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
}

function exitFullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    }
}

/* ================= DEVICE ================= */
function selectDevice(d) {
    device = d;

    deviceScreen.classList.add("hidden");
    testScreen.classList.remove("hidden");

    frame.style.width = devices[d][0] + "px";
    frame.style.height = devices[d][1] + "px";

    loadVideo();
}

/* ================= PRZYKŁADOWY VIDEO ================= */
function loadExampleVideo() {
    exampleRating = null;
    const exampleRatingButtons = document.querySelectorAll("#exampleRatingContainer .rating-btn");
    exampleRatingButtons.forEach(b => b.classList.remove("selected"));

    document.getElementById("exampleRatingContainer").classList.add("hidden");
    document.getElementById("exampleVideoContainer").classList.remove("hidden");

    exampleVideo.src = "/static/videos/" + videos[0];
    exampleVideo.controls = false;
    exampleVideo.oncontextmenu = (e) => e.preventDefault();

    exampleVideo.onloadeddata = () => {
        enterFullscreen(exampleVideo);
        exampleVideo.play();
    };

    exampleVideo.onended = () => {
        exitFullscreen();
        showExampleRating();
    };
}

function showExampleRating() {
    document.getElementById("exampleVideoContainer").classList.add("hidden");
    document.getElementById("exampleRatingContainer").classList.remove("hidden");
}

function selectExampleRating(r) {
    exampleRating = r;
    const exampleRatingButtons = document.querySelectorAll("#exampleRatingContainer .rating-btn");
    exampleRatingButtons.forEach(b => b.classList.remove("selected"));
    exampleRatingButtons[r - 1].classList.add("selected");
}

function confirmExampleRating() {
    if (!exampleRating) {
        alert("Wybierz ocenę");
        return;
    }

    // Przykładowy test nie zapisuje do CSV
    exampleTestScreen.classList.add("hidden");
    startRealTestScreen.classList.remove("hidden");
}

/* ================= VIDEO ================= */
function loadVideo() {
    rating = null;
    const ratingButtons = document.querySelectorAll("#ratingContainer .rating-btn");
    ratingButtons.forEach(b => b.classList.remove("selected"));

    ratingContainer.classList.add("hidden");
    videoContainer.classList.remove("hidden");

    video.src = "/static/videos/" + shuffledVideos[videoIndex];
    // Wyłączamy kontrolki i dodatkowe możliwości pauzowania
    video.controls = false;
    video.oncontextmenu = (e) => e.preventDefault();

    video.onloadeddata = () => {
        enterFullscreen(video);
        video.play();
    };

    video.onended = () => {
        exitFullscreen();
        showRating();
    };
}


/* ================= OCENA ================= */
function showRating() {
    videoContainer.classList.add("hidden");
    ratingContainer.classList.remove("hidden");
}


function selectRating(r) {
    rating = r;
    const ratingButtons = document.querySelectorAll("#ratingContainer .rating-btn");
    ratingButtons.forEach(b => b.classList.remove("selected"));
    ratingButtons[r - 1].classList.add("selected");
}

function confirmRating() {
    if (!rating) {
        alert("Wybierz ocenę");
        return;
    }

    fetch("/save", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            tester: testerData.id,
            age: testerData.age,
            gender: testerData.gender,
            genre: testerData.genre,
            video: shuffledVideos[videoIndex],
            device: device,
            rating: rating
        })
    });

    videoIndex++;
    video.style.display = "block";

    if (videoIndex >= shuffledVideos.length) {
        testScreen.classList.add("hidden");
        endScreen.classList.remove("hidden");
        return;
    }

    loadVideo();
}
</script>


</body>
</html>
